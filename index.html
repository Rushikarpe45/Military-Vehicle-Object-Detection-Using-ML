<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Plate Detection</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            color: #333;
        }

        header {
            background-color: #6c63ff;
            color: #fff;
            padding: 15px;
            text-align: center;
        }

        .camera-frame {
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
            max-height: 350px;
            width: 100%;
            object-fit: cover;
        }

        .table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert {
            display: none;
        }

        .btn-group {
            gap: 10px;
        }

        .section-title {
            font-weight: bold;
            color: #495057;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <header>
        <h1>License Plate Detection System</h1>
    </header>

    <div class="container mt-4">

        <div class="row mb-4">
            <!-- Camera Feed -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header text-center">
                        <h4 class="section-title">Live Camera Feed</h4>
                    </div>
                    <div class="card-body">
                        <img src="/video_feed" class="camera-frame" alt="Live Camera Feed">
                    </div>
                </div>
            </div>

            <!-- Last Captured Plates -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header text-center">
                        <h4 class="section-title">Last Captured Plates</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <ul class="list-group" id="captured-plates">
                                <li class="list-group-item text-center">No plates captured yet.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <!-- Input and Controls -->
                <div class="row g-3 align-items-center mb-4">
                    <div class="col-lg-6 d-flex align-items-center">
                        <label for="plate" class="form-label">Detected Plate:</label>
                        <input type="text" id="plate" class="form-control" value="No Plate Detected" readonly>
                    </div>
                    <div class="col-lg-6">
                        <button class="btn btn-primary w-100" onclick="capturePlate()">Capture</button>
                    </div>
                </div>
    
                <div class="row g-3 align-items-center mb-4">
                    <div class="col-lg-6 d-flex align-items-center">
                        <label for="aplate" class="form-label">Captured Plate:</label>
                        <input type="text" id="aplate" class="form-control" value="No Plate Selected" readonly>
                    </div>
                    <div class="col-lg-6 d-flex btn-group">
                        <button class="btn btn-success flex-fill" onclick="addPlate()">Add to Authorized</button>
                        <button class="btn btn-warning flex-fill" onclick="checkPlate()">Check Authorization</button>
                    </div>
                </div>
    
                <p id="auth-status" class="alert mx-auto text-center"></p>
            </div>
        </div>

        <!-- Today's Plate Scan Counts -->
        <div class="mt-5">
            <div class="card">
                <div class="card-header text-center">
                    <h4 class="section-title">Today's Plate Scan Counts</h4>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="plate-count-table">
                        <thead class="table-dark">
                            <tr>
                                <th>License Plate</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2" class="text-center">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function fetchCapturedPlates() {
            fetch('/last_captured_plates')
                .then(response => response.json())
                .then(data => {
                    const plateList = document.getElementById('captured-plates');
                    plateList.innerHTML = ''; // Clear existing items
                    if (data.plates && data.plates.length > 0) {
                        data.plates.forEach(plate => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item text-center';
                            listItem.textContent = plate;
                            plateList.appendChild(listItem);
                        });
                    } else {
                        plateList.innerHTML = '<li class="list-group-item text-center">No plates captured yet.</li>';
                    }
                })
                .catch(err => console.error("Error fetching captured plates:", err));
        }

        function fetchPlateCounts() {
            fetch('/plate_counts')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('plate-count-table').querySelector('tbody');
                    tableBody.innerHTML = ''; // Clear existing rows

                    if (data && data.length > 0) {
                        data.forEach(row => {
                            const tableRow = document.createElement('tr');
                            const plateCell = document.createElement('td');
                            const countCell = document.createElement('td');
                            plateCell.textContent = row.number_plate;
                            countCell.textContent = row.count;
                            tableRow.appendChild(plateCell);
                            tableRow.appendChild(countCell);
                            tableBody.appendChild(tableRow);
                        });
                    } else {
                        const noDataRow = document.createElement('tr');
                        noDataRow.innerHTML = '<td colspan="2" class="text-center">No data available</td>';
                        tableBody.appendChild(noDataRow);
                    }
                })
                .catch(err => console.error("Error fetching plate counts:", err));
        }

        function detectPlate() {
            fetch('/detected_plate')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('plate').value = data.plate || "No Plate Detected";
                })
                .catch(err => console.error("Error fetching plate:", err));
        }

        function capturePlate() {
            document.getElementById('aplate').value = document.getElementById('plate').value;
        }

        function addPlate() {
            fetch('/add_plate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    plate: document.getElementById('aplate').value
                })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('auth-status').innerText = data.message || "";
                    document.getElementById('auth-status').style.display = "block";
                })
                .catch(err => console.error("Error adding plate:", err));
        }

        function checkPlate() {
            fetch('/check_plate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    plate: document.getElementById('aplate').value
                })
            })
                .then(response => response.json())
                .then(data => {
                    const alertBox = document.getElementById('auth-status');
                    alertBox.style.display = "block";
                    alertBox.textContent = data.message || "";

                    if (data.message === "Not Authorized") {
                        alertBox.className = "alert alert-danger mx-auto text-center";
                    } else if (data.message === "Authorized") {
                        alertBox.className = "alert alert-success mx-auto text-center";
                    }
                })
                .catch(err => console.error("Error checking plate:", err));
        }

        // Automatically update the detected plate, captured plates list, and plate counts
        setInterval(() => {
            detectPlate();
            fetchCapturedPlates();
            fetchPlateCounts();
        }, 10000);
    </script>
</body>

</html>